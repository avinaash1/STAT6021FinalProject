---
title: "proj1"
author:  "Khoi Tran (kt2np), Avinaash Pavuloori (akp8vy), Jordan Hiatt (jdh2e), Nick Thompson (nat3fa)"
date: "November 16, 2020"
output: html_document
---

### STAT 6021 Final Project: Analyzing NBA Salaries

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(stringi)
library(stringr)
library(readr)
library(rvest)
library(twitteR)
library(corrplot)
library(ggplot2)
library(GGally)
library(ISLR)
library(glmnet)
library(MASS)
library(faraway)
library(scales)
library(lawstat)
library(tidyverse)

## burner twitter profile
## used just for scraping data for this project
## choose 'no' when asked to use a local file for token
setup_twitter_oauth('2PRpIuOuFUMjw6glM5WoYlEpw',
                    'inbMp0C9wfAKHYd3Wl5WstDSRDzEwEeqSmWATw9ZiB23uAU5Px',
                    '1332888461905448962-Ew4sIQBnhBfSMpZyR4nJgJ5MBXaDAP',
                    'nKNXV2Qp8LqZ39ZuLlIEqFdsnX9lfmeVzEiolGZcBuUB4')
```

```{r}
## reading in and cleaning data
# player name, team, salaries for 2019-2020 season only
# drop first column from player salaries
playersalary <- read.csv(file = 'nba_salary.csv', header = TRUE, skip = 1)[-c(1), c(2, 3, 4, 10, 11)]

# drop first column from player stats
playerstats <- read.csv(file = 'nba_player_stats.csv', header = TRUE)[-c(1)]

# change data types for 'playersalary'
playersalary <- transform(playersalary,
                          Player = as.character(Player),
                          Tm = as.character(Tm),
                          X2019.20 = as.character(X2019.20) %>% parse_number(),
                          Signed.Using = as.character(Signed.Using),
                          Guaranteed = as.character(Guaranteed) %>% parse_number())

# aggregate player stats for season-long total, to account for mid-season trades
# aggregate player positions as well, separately
# use 'head' function to grab instances of players playing multiple positions
playerstats_agg <- merge(aggregate(playerstats[2:3], by = playerstats['Player'], FUN = head, 1),
                         aggregate(playerstats[5:29], by = playerstats['Player'], FUN = sum),
                         by = c('Player'))

# aggregate player salary for season-long total, to account for mid-season trades# aggregate on max values for salary and guarantees, per player and per team
playersalary_agg <- aggregate(playersalary[c(3, 5)], by = list(playersalary$Player, playersalary$Tm), FUN = max)

# aggregate this data frame again, this time by player alone, to find total salary per player of the 2019-2020 season
playersalary_agg <- aggregate(playersalary_agg[3:4], by = playersalary_agg[1], FUN = sum)
names(playersalary_agg)[1] <- 'Player'

# merge aggregated 'playerstats' with 'playersalary' on player names
player_salarystats <- merge(playersalary_agg,
                            playerstats_agg,
                            by = c('Player'))

## get url for per-player stats
player_salarystats$url <- strsplit(player_salarystats$Player, '\\', fixed = TRUE)
# cleaned player names
player_salarystats$Player <- sapply(player_salarystats$url, `[[`, 1)
# part of player profile url
player_salarystats$url <- sapply(player_salarystats$url, `[[`, 2)
# full player profile url, from basketball-reference.com
player_salarystats$url <- stri_join('https://www.basketball-reference.com/players/',
                                    substr(player_salarystats$url, start = 1, stop = 1), '/',
                                    player_salarystats$url, '.html')
```

```{r}
# create function for shortening xpaths
xpath_short <- function(contains, xpath) {
  if(missing(xpath)) {
    # if there is no appending xpath
    xpath_final <- paste('//div[@id="wrap"]//div[@id="meta"]/div[@itemscope]/p[contains(., "',
                           contains,
                           '")]',
                           sep = '')
  } else {
    # if there is an appending xpath
    xpath_final <- paste('//div[@id="wrap"]//div[@id="meta"]/div[@itemscope]/p[contains(., "',
                           contains,
                           '")]',
                           xpath,
                           sep = '')
  }
  return(xpath_final)
}
```

```{r}
## list to add variables to data frame
new_vars <- c('yrs_exp', 'age_yrs',
              'draft_num', 'debut_yr',
              'num_accolades', 'num_teams_1920',
              'mid_season_trades', 'team',
              'num_yrs_current_team', 'num_teams_played',
              'injury_yrs', 'twitter_followers',
              'NBA_titles', 'all_NBA')
player_salarystats[, new_vars] <- NA
```

```{r}
## for loop, scraping data per-player, per-game stats
## will have lots of NA errors, due to missing elements (not all players were drafted or have Twitter profiles, for example)
for (i in 1:nrow(player_salarystats)) {
  ### scrape table of total player stats
  # split on the empty row, create if-then for this, as not all players will have a per-team section of the table
  # need to aggregate data, multiply per-game stats by num games played per-season, per-team to recalculate total values
  player_stats <- read_html(player_salarystats$url[i]) %>%
                    html_nodes('table') %>%
                    html_table() %>%
                    data.frame()

  ## if statement to separate table, as it includes summary stats for more veteran players (have been traded)
  ## modify to to account for injury (separate if statement?)
  # e.g. for 30th player, Ben Simmons ('https://www.basketball-reference.com/players/s/simmobe01.html')
  if (TRUE %in% grepl('injury', player_stats$Tm, fixed = TRUE)) {
    # set num years injured to number of rows where injury was indicated
    player_salarystats$injury_yrs[i] <- grepl('injury', player_stats$Tm, fixed = TRUE) %>%
                                          sum()
    # subset table to exclude injury year rows, as it is not cleanly formatted data
    player_stats <- player_stats[!grepl('injury', player_stats$Tm, fixed = TRUE), ]
  } else {
    # set num injured years to zero if there is no row indicating the player missed a season due to injury
    player_salarystats$injury_yrs[i] = 0
  }

  # set player stats data where applicable to numeric values
  player_stats[, 6:30] <- sapply(player_stats[, 6:30], as.numeric)

  if ('' %in% player_stats$Season) {
    # if there is a blank row in the scraped table, then the player has been traded
    # there will be a second partition to the table
    player_stats_per_season <- player_stats[1:(which(player_stats$Season == '') - 1),]

    # part of the scraped table that does not exist if there is no blank row
    # player stats by team they have played ondf
    player_stats_per_team <- player_stats[(which(player_stats$Season == '') + 1):nrow(player_stats),]

    # cleaning per team df
    # table scraped is per-game, so multiply certain variables by number of games played
    player_stats_per_team[-c(1:8, 11, 14, 17, 18, 21)] <- sapply(player_stats_per_team[-c(1:8, 11, 14, 17, 18, 21)] *
                                                                 player_stats_per_team$G, round)

    ## num teams Played For, total
    ## see: if statement above, set to 1 if never traded
    player_salarystats$num_teams_played[i] <- nrow(player_stats_per_team)

  } else {
    # if there is no blank row in the scraped table, then the player has never been traded
    player_stats_per_season <- player_stats

    ## num teams Played For, total
    ## see: if statement above, set to 1 if never traded
    player_salarystats$num_teams_played[i] <- 1
  }

  # table scraped is per-game, so multiply certain variables by number of games played
  # multiply everything but 1:6, 11, 14, 17, 18, 21 (all per-game stats) by player_stats_per_season$MP
  # round everything for totals
  player_stats_per_season[-c(1:8, 11, 14, 17, 18, 21)] <- sapply(player_stats_per_season[-c(1:8, 11, 14, 17, 18, 21)] *
                                                                   player_stats_per_season$G, round)

  ### assign variables to data frame
  ### separate player_stats_per_team for just 2019-20 season to create several variables
  player_stats_1920 <- player_stats_per_season[which(player_stats_per_season$Season == '2019-20'), ]
  ## num teams Played For in 2019-20 season
  player_salarystats$num_teams_1920[i] <- player_stats_1920 %>%
                                            nrow()
  ## number of mid-season trades (num teams in 2019-20 - 1)
  # untraded players will have 0
  player_salarystats$mid_season_trades[i] <- player_stats_1920 %>%
                                              nrow() - 1
  ## final team (for 'Team' stat in aggr df)
  player_salarystats$team[i] <- tail(player_stats_1920$Tm, n = 1)
  # num yrs played with current team
  # will be '1' if mid-season traded
  player_salarystats$num_yrs_current_team[i] <- sum(player_stats_per_season$Tm == tail(player_stats_1920$Tm, n = 1))

  ## read_html() per player url
  player_url <- read_html(player_salarystats$url[i])
  ## NBA experience
  player_salarystats$yrs_exp[i] <- player_url %>%
                                    html_node(xpath = xpath_short('Experience')) %>%
                                    html_text() %>%
                                    str_extract('\\d+') %>%
                                    as.numeric()
  ## Age
  # 365.2422 days per year, use datetime functions
  ##note: modify Sys.Date(), replace with end date of 2020 season (Oct 11, 2020##
  player_salarystats$age_yrs[i] <- difftime('2020-10-11',
                                            player_url %>%
                                              html_node(xpath = xpath_short('Born', '/span/@data-birth')) %>%
                                              html_text(),
                                            units = 'days') %>%
                                    as.numeric() / 365.2422
  ## Draft Pick
  # 'stri_extract_last_regex' picks last number in string
  # 30 picks per draft round, calculate draft round off this after creating df
  player_salarystats$draft_num[i] <- player_url %>%
                                      html_node(xpath = xpath_short('Draft', '/a[1]/following-sibling::text()')) %>%
                                      html_text() %>%
                                      stri_extract_last_regex('\\d+') %>%
                                      as.numeric()
  ## Draft Year
  # 'stri_extract_last_regex' picks last number in string
  ## replace with 'Debut Year' variable
  player_salarystats$debut_yr[i] <- player_url %>%
                                      html_node(xpath = xpath_short('Debut', '/a')) %>%
                                      html_text() %>%
                                      stri_extract_last_regex('\\d+') %>%
                                      as.numeric()
  ## Num Accolades
  player_salarystats$num_accolades[i] <- player_url %>%
                                          html_node(xpath = '//div[@id="wrap"]//ul[@id="bling"]') %>%
                                          as.character() %>%
                                          str_count(pattern = '</a>')

  ## NBA titles
  player_salarystats$NBA_titles[i] <- player_url %>%
                                        html_node(xpath = '//div[@id="wrap"]//ul[@id="bling"]//li[contains(., "NBA Champ")]/a') %>%
                                        html_text() %>%
                                        str_extract('\\d+')

  ## All-NBA status
  ## use 'and' statement for xpath, as there's inconsistent formatting; some pages have 'All-Star', others have 'All Star'
  player_salarystats$all_NBA[i] <- read_html(player_salarystats$url[i]) %>%
                                    html_node(xpath = '//div[@id="wrap"]//ul[@id="bling"]//a[contains(., "All") and contains(., "NBA")]') %>%
                                    html_text() %>%
                                    str_extract('\\d+')
}
```

```{r}
## set Twitter scraping in a different loop to avoid sensitivity re: rate limits
## avoid rerunning as much as possible
for (j in 1:nrow(player_salarystats)) {
  ## read_html() per player url
  player_url <- read_html(player_salarystats$url[j])
  ## Twitter profile
  twitter_profile <- tryCatch(player_url %>%
                               html_node(xpath = xpath_short('Twitter', '/a[contains(@href, "twitter.com")]/text()')) %>%
                               html_text() %>%
                               getUser(),
                             error = function(err) NA)

  ## if statement to handle invalid or nonexistent Twitter profiles
  ## WARNING: slow and will have lots of red text in your console
  if (is.na(twitter_profile)) {
    # if a valid twitter profile cannot be found, set followers = 0
    player_salarystats$twitter_followers[j] <- 0
  } else {
    # if a valid twitter profile can be found, return num followers
    player_salarystats$twitter_followers[j] <- twitter_profile$followersCount
  }
}
```

```{r}
### additional cleaning before exporting to .csv
NBA_salary_stats <- player_salarystats

## set team, position as factor variables
NBA_salary_stats$team <- NBA_salary_stats$team %>%
                            as.factor()
NBA_salary_stats$Pos <- NBA_salary_stats$Pos %>%
                            as.factor()

## rename actual paid salary variable
names(NBA_salary_stats)[names(NBA_salary_stats) == 'X2019.20'] <- 'Actual'

## drop first Age variable
## age_yrs is a more accurate variable that calculates age as of the end of the 2019-2020 season
NBA_salary_stats <- subset(NBA_salary_stats, select = -Age)

## create binary categorical variable for whether the player was drafted or not
NBA_salary_stats$drafted <- ifelse(NBA_salary_stats$draft_num == 0, FALSE, TRUE)

## create variable for starting percentage (GS / G)
NBA_salary_stats$GS. <- NBA_salary_stats$GS / NBA_salary_stats$G

## clean percentage-based stats to account for aggregation
NBA_salary_stats$FG. <- NBA_salary_stats$FG / NBA_salary_stats$FGA
NBA_salary_stats$X3P. <- NBA_salary_stats$X3P / NBA_salary_stats$X3PA
NBA_salary_stats$X2P. <- NBA_salary_stats$X2P / NBA_salary_stats$X2PA
NBA_salary_stats$FT. <- NBA_salary_stats$FT / NBA_salary_stats$FTA
NBA_salary_stats$eFG. <- (NBA_salary_stats$FG + 0.5 * NBA_salary_stats$X3P) / NBA_salary_stats$FGA

## clean NBA titles and all-NBA status variables
## if a year is returned (4-digit variable), then they have only won one title or earned all-NBA status once
## otherwise, the variable indicates the number of times they have earned these things
NBA_salary_stats$NBA_titles <- ifelse(nchar(NBA_salary_stats$NBA_titles) == 4,
                                      1,
                                      NBA_salary_stats$NBA_titles) %>%
                                  as.numeric()
NBA_salary_stats$all_NBA <- ifelse(nchar(NBA_salary_stats$all_NBA) == 4,
                                     1,
                                     NBA_salary_stats$all_NBA) %>%
                              as.numeric()

## replace NAs with 0
# e.g. draft_num (not all players were drafted) and num_accolades (not all players have accolades)
NBA_salary_stats[is.na(NBA_salary_stats)] <- 0

## code to output new csv for combined dataset
write.csv(NBA_salary_stats,
          'NBA_salary_stats.csv')
```

---

## A Review of the Variables

# From the [Basketball Reference data](https://www.basketball-reference.com/):

- **Player:** The NBA player's name.
- **Actual:** The player's actual paid salary for the 2019-2020 NBA season.
- **Guaranteed:** The player's guaranteed salary for the 2019-2020 NBA season.
- **Pos:** The player's position played.
- **G:** Number of games played in the 2019-2020 NBA season.
- **GS:** Number of games started in the 2019-2020 NBA season.
- **GS.:** Percentage of games started in the 2019-2020 NBA season.
- **MP:** Number of minutes played during the 2019-2020 NBA season.
- **FG:** Field goals scored.
- **FGA:** Field goals attempted.
- **FG.:** Field goal percentage (number scored divided by number attempted).
- **3P:** 3-point field goals scored.
- **3PA:** 3-point field goals attempted.
- **3P.:** 3-point field goal percentage (number scored divided by number attempted).
- **2P:** 2-point field goals scored.
- **2PA:** 2-point field goals attempted.
- **2P.:** 2-point field goal percentage (number scored divided by number attempted).
- **eFG.:** Effective field goal percentage, adjusted for the higher value of a 3-point field goal.
- **FT:** Free throws scored.
- **FTA:** Free throws attempted.
- **FT.:** Free throw percentage (number scored divided by number attempted).
- **ORB:** Offensive rebounds.
- **DRB:** Defensive rebounds.
- **TRB:** Total rebounds (offensive plus defensive).
- **AST:** Number of assists.
- **STL:** Number of steals.
- **BLK:** Number of blocks.
- **TOV:** Number of turnovers.
- **PF:** Number of personal fouls.
- **PTS:** Points scored.

# Recalculated and scraped variables:
- **yrs_exp:** The number of years the player has played in the NBA.
- **age_yrs:** The player's age as of the end of the 2019-2020 NBA season.
- **draft_num:** The player's draft number. Draft round can be calculated by factoring in the fact that there are 30 players drafted per round in the NBA draft. This value is set to zero if the player was not drafted and joined the NBA via other means.
- **drafted:** A boolean categorical variable to indicate whether the player was drafted or not.
- **debut_yr:** The year the player played their first NBA game. Generally equates to the year the player was drafted or contracted, but there are a few cases of a player being injured between their draft year and debut year. 
- **num_accolades:** The number of notable accolades a player has.
- **NBA_titles:** The number of the NBA titles the player has won.
- **all_NBA:** The number of times the player has earned all-NBA status.
- **num_teams_1920:** The number of teams a player has played for during the 2019-2020 season.
- **mid_season_trades:** The number of times a player was traded to another team during the 2019-2020 season.
- **team:** The team the player plays for, as of the end of the 2019-2020 season.
- **num_yrs_current_team:** How long the player has played for their current team. 
- **num_teams_played:** The number of teams the player has played for throughout the duration of their career.
- **injury_yrs:** The number of years the player has spent an entire season injured.
- **twitter_followers:** The number of followers the player has on Twitter. This variable attempts to encapsulate whether a player's popularity (measured by the size of their social media following) has an influence on their salary.

```{r}
# exploratory data analysis
## reading in data
kt_data <- read.csv(file = 'NBA_salary_stats.csv', 
                    row.names = 1, 
                    header = TRUE)
```

```{r}
# drop Guaranteed salary in exchange for using Actual pay when predicting salary (index = 3rd column)
### correlation plots, 2019-20 season performance stats
## correlation plots for total point scoring
other_perf <- c('ORB', 'DRB', 'AST', 'STL', 'BLK', 'TOV', 'PF')
performance_stats <- c('Actual', 'MP', 'GS', 'X2P', 'X3P', 'FT')
corrplot(cor(subset(kt_data, select = c(performance_stats, other_perf)),
             use = 'complete.obs'),
         method = 'circle',
         type = 'upper')

cor(subset(kt_data, select = performance_stats)) %>% 
  pairs()
```

```{r}
## correlation plots with accuracy (e.g. 3-point percentage)
performance_stats_pct <- c('Actual', 'MP', 'GS.', 'X2P.', 'X3P.', 'FT.')
corrplot(cor(subset(kt_data, select = c(performance_stats_pct, other_perf)),
             use = 'complete.obs'),
         method = 'circle',
         type = 'upper')

cor(subset(kt_data, select = performance_stats_pct)) %>% 
  pairs()
```

```{r}
## correlation plots with attempts (e.g. 3-point attempts)
performance_stats_atmpt <- c('Actual', 'MP', 'G', 'X2PA', 'X3PA', 'FTA')
corrplot(cor(subset(kt_data, select = c(performance_stats_atmpt, other_perf)),
             use = 'complete.obs'),
         method = 'circle',
         type = 'upper')

cor(subset(kt_data, select = performance_stats_atmpt)) %>% 
  pairs()
```

```{r}
### correlation plots, overall career statistics
# e.g. mid-season trades, experience, age, etc.
other_stats <- c('Actual', 'yrs_exp', 'age_yrs', 'draft_num', 
                 'num_accolades', 'NBA_titles', 'all_NBA', 'num_teams_1920', 
                 'mid_season_trades', 'num_yrs_current_team', 
                 'num_teams_played', 'injury_yrs', 'twitter_followers', 'drafted')
corrplot(cor(subset(kt_data, select = other_stats), 
             use = 'complete.obs'),
         method = 'circle',
         type = 'upper')

cor(subset(kt_data, select = other_stats)) %>% 
  pairs()
```

```{r}
## list variables most correlated to actual salary
cor(subset(kt_data, select = performance_stats))[, 1]
# GS, X2P, FT are > 0.5
# X3P > 0.38
# MP is a decent correlator in all performance-related correlations
cor(subset(kt_data, select = performance_stats_pct))[, 1]
# GS. is > 0.5
cor(subset(kt_data, select = performance_stats_atmpt))[, 1]
# FTA and X2PA are > 0.5
# X3PA > 0.39
cor(subset(kt_data, select = other_stats))[, 1]
# yrs_exp, num_accolades are > 0.5
# age_yrs, all_NBA, num_yrs_current_team, twitter_followers > 0.3
cor(subset(kt_data, select = c('Actual', other_perf)))[, 1]
# DRB, AST, TOV are > 0.5
# ORB, STL, BLK, and PF are > 0.3
```

```{r}
## regression with all variables but player name, guaranteed salary, link to url, and team
lm(Actual ~ ., data = kt_data[-c(1, 3, 30, 38)]) %>% 
  summary()
## regression with performance stats
lm(Actual ~ ., data = subset(kt_data, select = performance_stats)) %>% 
    summary()
## regression with performance stats, percentages
lm(Actual ~ ., data = subset(kt_data, select = performance_stats_pct)) %>% 
    summary()
## regression with performance stats, attempts
lm(Actual ~ ., data = subset(kt_data, select = performance_stats_atmpt)) %>% 
    summary()
## regression with other performance stats
lm(Actual ~ ., data = subset(kt_data, select = c('Actual', other_perf))) %>% 
    summary()
## regression with other stats
lm(Actual ~ ., data = subset(kt_data, select = other_stats)) %>% 
    summary()
```

# Most Significant Predictor Variables:

These variables exhibited high levels of significance, and should be selected for reduced models.

- **G:** Number of games played in the 2019-2020 NBA season.
- **GS.:** Percentage of games started in the 2019-2020 NBA season.
- **GS.:** Percentage of games started in the 2019-2020 NBA season.
- **FT:** Free throws scored.
- **FTA:** Free throws attempted.
- **DRB:** Defensive rebounds.
- **AST:** Number of assists.
- **PF:** Number of personal fouls.
- **yrs_exp:** The number of years the player has played in the NBA.
- **num_accolades:** The number of notable accolades a player has.
- **NBA_titles:** The number of the NBA titles the player has won.
- **num_teams_1920:** The number of teams a player has played for during the 2019-2020 season.
- **num_teams_played:** The number of teams the player has played for throughout the duration of their career.

```{r}
## all stats from lists
lm(Actual ~ ., data = subset(kt_data, select = c(performance_stats, performance_stats_pct, 
                                                 performance_stats_atmpt, other_perf, other_stats) %>% 
                                                  unique())) %>% 
    summary()

## regression with variables observed in previous regressions to be significant
# use GS. alone instead of G and GS
lm(Actual ~ GS. + FT + FTA + DRB + AST + PF + 
            yrs_exp + num_accolades + NBA_titles + 
            num_teams_1920 + num_teams_played, 
    data = kt_data) %>% 
      summary()

## further reduced regression, more significant
kt_lm1 <- lm(Actual ~ GS. + DRB + PF + yrs_exp + 
                      num_accolades + NBA_titles + 
                      num_teams_1920 + num_teams_played, 
   data = kt_data) %>% 
    summary()

## stepwise regression
# list c(1, 3, 30, 38) excludes non-numeric variables (name, url, team) and guaranteed salary
step(lm(formula = Actual ~ 1, data = kt_data[-c(1, 3, 30, 38)]), 
     scope = list(lower = lm(formula = Actual ~ 1, data = kt_data[-c(1, 3, 30, 38)]), 
                  upper = lm(formula = Actual ~ ., data = kt_data[-c(1, 3, 30, 38)])), 
     direction = 'both')

## suggested regression
kt_lm2 <- lm(formula = Actual ~ num_accolades + PTS + yrs_exp + num_teams_played + 
                                GS. + NBA_titles + num_teams_1920 + PF + DRB + GS + 
                                X2P. + FT + all_NBA + FTA + Pos, 
             data = kt_data)

## reduced further to
kt_lm3 <- lm(formula = Actual ~ yrs_exp + num_teams_played + GS. + 
                                NBA_titles + num_teams_1920 + PF + DRB, 
             data = kt_data)
```

```{r}
## analysis
kt_lm1 %>% 
  summary()
kt_lm2 %>% 
  summary()
kt_lm3 %>% 
  summary()
```

```{r}
## boxcox plots
kt_bxcx2 <- boxcox(kt_lm2, seq(-1, 1))
kt_bxcx3 <- boxcox(kt_lm3, seq(-1, 1))

## finding optimal lambda to transform y-variables
kt_bxcx2$x[which.max(kt_bxcx2$y)]
kt_bxcx3$x[which.max(kt_bxcx3$y)]
```

```{r}
## transforming y, comparing models
# suggested regression from stepwise, transformed
kt_lm4 <- lm(formula = Actual^(1/3) ~ num_accolades + PTS + yrs_exp + num_teams_played + 
                                      GS. + NBA_titles + num_teams_1920 + PF + DRB + GS + 
                                      X2P. + FT + all_NBA + FTA + Pos, 
             data = kt_data)

# suggested regression, reduced+transformed
kt_lm5 <- lm(Actual^(31/99) ~ yrs_exp + num_teams_played + GS. + 
                              NBA_titles + num_teams_1920 + PF + DRB, 
             data = kt_data)

## analysis
kt_lm4 %>% 
  summary()
kt_lm5 %>% 
  summary()
```

```{r}
## equality of variance assumption test
# H0: variances are the same
# HA: variances are not the same for all classes
# p-value = 0.3377 is greater than 0.05, so H0 may be rejected
levene.test(kt_data$Actual^(1/3), kt_data$Pos)

## creating dummy variables
kt_data_pos <- kt_data %>% 
                  mutate(posC = ifelse(grepl('C', Pos, fixed = TRUE), 1, 0), 
                         posPF = ifelse(grepl('PF', Pos, fixed = TRUE), 1, 0), 
                         posPG = ifelse(grepl('PG', Pos, fixed = TRUE), 1, 0), 
                         posSF = ifelse(grepl('SF', Pos, fixed = TRUE), 1, 0), 
                         posSG = ifelse(grepl('SG', Pos, fixed = TRUE), 1, 0), 
                         multiposition = ifelse(grepl('-', Pos, fixed = TRUE), 1, 0))

## set dummy variables as factors
## necessary, as many players play multiple positions
kt_data_pos[c('posC', 'posPF', 'posPG', 'posSF', 'posSG', 'multiposition')] <- lapply(kt_data_pos[c('posC', 'posPF', 'posPG', 
                                                                                                    'posSF', 'posSG', 'multiposition')], factor)

## plotting
par(mar = c(5, 8, 4, 2) + 0.1)
plot(kt_data_pos[which(kt_data_pos$posC == 1), ]$PTS, 
     kt_data_pos[which(kt_data_pos$posC == 1), ]$Actual^(1/3), 
     main = 'Actual Income against Points Scored, by Position', 
     pch = 20, xlab = 'Points Scored', ylab = '', 
     yaxt = 'n', ylim = c(25, 375))
title(ylab = 'Salary (to the power of 1/3)', line = 5, cex.lab = 1)
axis(2, las = 2, cex.axis = 0.75, 
     at = seq(50, 350, by = 50), 
     labels = comma(exp(log(seq(50, 350, by = 50)) / (1/3))))
points(kt_data_pos[which(kt_data_pos$posPF == 1), ]$PTS, 
       kt_data_pos[which(kt_data_pos$posPF == 1), ]$Actual^(1/3), 
       pch = 20, col = 'red')
points(kt_data_pos[which(kt_data_pos$posPG == 1), ]$PTS, 
       kt_data_pos[which(kt_data_pos$posPG == 1), ]$Actual^(1/3), 
       pch = 20, col = 'blue')
points(kt_data_pos[which(kt_data_pos$posSF == 1), ]$PTS, 
       kt_data_pos[which(kt_data_pos$posSF == 1), ]$Actual^(1/3), 
       pch = 20, col = 'green')
points(kt_data_pos[which(kt_data_pos$posSG == 1), ]$PTS, 
       kt_data_pos[which(kt_data_pos$posSG == 1), ]$Actual^(1/3), 
       pch = 20, col = 'orange')
abline(lm(Actual^(1/3) ~ PTS, data = kt_data_pos[which(kt_data_pos$posC == 1), ]), lty = 1)
abline(lm(Actual^(1/3) ~ PTS, data = kt_data_pos[which(kt_data_pos$posPF == 1), ]), lty = 1, col = 'red')
abline(lm(Actual^(1/3) ~ PTS, data = kt_data_pos[which(kt_data_pos$posPG == 1), ]), lty = 1, col = 'blue')
abline(lm(Actual^(1/3) ~ PTS, data = kt_data_pos[which(kt_data_pos$posSF == 1), ]), lty = 1, col = 'green')
abline(lm(Actual^(1/3) ~ PTS, data = kt_data_pos[which(kt_data_pos$posSG == 1), ]), lty = 1, col = 'orange')
legend('right', 
       c('C', 'PF', 'PG','SF', 'SG'), 
       lty = 1:5, cex = 0.75,
       col = c('black', 'red', 'blue', 'green', 'orange'))
```

```{r}
## fourth model, with position for comparison
kt_lm4 %>% 
  summary()

## new model, with dummy variables
lm(formula = Actual^(1/3) ~ num_accolades + PTS + yrs_exp + 
                            num_teams_played + GS. + NBA_titles + 
                            num_teams_1920 + PF + DRB + GS + X2P. + 
                            FT + all_NBA + FTA + posC + posPF + 
                            posPG + posSF + posSG, 
          data = kt_data_pos) %>% 
  summary()

## comparing to fourth model
anova(kt_lm4, 
      lm(formula = Actual^(1/3) ~ num_accolades + PTS + yrs_exp + 
                                  num_teams_played + GS. + NBA_titles + 
                                  num_teams_1920 + PF + DRB + GS + X2P. + 
                                  FT + all_NBA + FTA + posC + posPF + 
                                  posPG + posSF + posSG, 
          data = kt_data_pos))
```

# Exploring The Importance Of Player Position

##not very important, write section##

```{r}
## further reduced model, including points scored
boxcox(lm(Actual ~ yrs_exp + num_teams_played + 
                   PTS + GS., data = kt_data))$x[which.max(boxcox(lm(Actual ~ yrs_exp + num_teams_played + 
                                                                               PTS + GS., data = kt_data))$y)]
kt_lm6 <- lm(Actual^(2/9) ~ yrs_exp + num_teams_played + 
                            PTS + GS., data = kt_data)
kt_lm6 %>% 
  summary()
## without PF (personal fouls), shown to be insignificant
boxcox(lm(Actual ~ yrs_exp + num_teams_played + GS. + NBA_titles + 
          num_teams_1920 + DRB, data = kt_data))$x[which.max(boxcox(lm(Actual ~ yrs_exp + num_teams_played + GS. + NBA_titles + 
                                                                       num_teams_1920 + DRB, data = kt_data))$y)]
## power of 0.222222
kt_lm7 <- lm(Actual^(2/9) ~ yrs_exp + num_teams_played + GS. + NBA_titles + 
                            num_teams_1920 + DRB, data = kt_data)
kt_lm7 %>% 
  summary()

## interactive variable
kt_lm8 <- lm(Actual ~ yrs_exp * num_teams_played + GS. + NBA_titles + 
                      num_teams_1920 + DRB, data = kt_data)
boxcox(kt_lm8)$x[which.max(boxcox(kt_lm8)$y)]
## power of 0.262626
kt_lm9 <- lm(Actual^(26/99) ~ yrs_exp * num_teams_played + GS. + NBA_titles + 
                              num_teams_1920 + DRB, data = kt_data)
kt_lm9 %>% 
  summary()

# drop NBA titles and num_teams_1920 from interactive variable model
kt_lm10 <- lm(Actual ~ yrs_exp * num_teams_played + 
                        GS. + DRB, data = kt_data)
boxcox(kt_lm10)$x[which.max(boxcox(kt_lm10)$y)]
kt_lm11 <- lm(Actual^(26/99) ~ yrs_exp * num_teams_played + 
                                GS. + DRB, data = kt_data)
kt_lm11 %>% 
  summary()
```

```{r}
## reduced dataset for further analysis
kt_data1 <- sapply(subset(kt_data, select = c(performance_stats, other_perf, 
                                              other_stats) %>% unique()), as.numeric) %>% 
              data.frame()
kt_data2 <- sapply(subset(kt_data, select = c(performance_stats, performance_stats_pct, 
                                              performance_stats_atmpt, other_perf, other_stats) %>% 
                                                unique()), as.numeric) %>% 
              data.frame()

## PCA
# first PCA, more reduced dataset
kt_pca1 <- prcomp(kt_data1, 
                  scale = TRUE)

# 95% of variance explained by first 14 PCAs
## after 14 PCAs, each successive PCA only explains <1% of additional variance
# 90% of variance explained by first 10 PCAs
## after 10 PCAs, each successive PCA only explains <2% of additional variance
# 75% of variance explained by first 6 PCAs
## after 6 PCAs, each successive PCA only explains <4% of additional variance

cumsum(kt_pca1$sdev^2 / sum(kt_pca1$sdev^2))

kt_pca1$rotation[, 1:14] %>% round(3) %>% abs()

# second PCA, less reduced dataset
kt_pca2 <- prcomp(kt_data2, 
                  scale = TRUE)

# 95% of variance explained by first 16 PCAs
## after 16 PCAs, each successive PCA only explains <1% of additional variance
# 90% of variance explained by first 12 PCAs
## after 12 PCAs, each successive PCA only explains <2% of additional variance
# 75% of variance explained by first 6 PCAs
## after 6 PCAs, each successive PCA only explains <4% of additional variance

cumsum(kt_pca2$sdev^2 / sum(kt_pca2$sdev^2))

kt_pca2$rotation[, 1:14] %>% round(3) %>% abs()
```

# Principal Component Analysis

Principal Component Analysis (PCA) was not a very useful method in the determination of an effective predictive model for NBA player salary; PCA was an ultimately ineffective method, as it required an excessive number of principal components to explain a reasonably high amount of variance. In both the restricted and unrestricted datasets, at least 10-12 PCAs were necessary to explain just 90% of the variance in the data.

```{r}
## lasso and  ridge regression
set.seed(19462)
nba_x <- model.matrix(Actual ~ ., kt_data2)[, -1]
nba_y <- kt_data2$Actual
# select a random sample
train <- sample(1:nrow(nba_x), nrow(nba_x) / 2)
# split data into testing
test_x <- (-train)
test_y <- nba_y[test_x]

# using CV to find the optimal lambda based on training set
set.seed(72347)

# fitting ridge regression
nba_cv <- cv.glmnet(nba_x[train, ],
                    nba_y[train],
                    alpha = 0)

NBA_ridge <- glmnet(nba_x[train, ],
                    nba_y[train],
                    alpha = 0,
                    lambda = nba_cv$lambda.min,
                    thresh = 1e-14)
# test MSE with optimal lambda
NBA_pred <- predict(NBA_ridge,
                    s = nba_cv$lambda.min,
                    newx = nba_x[test_x,])

# fitting lasso regression
nba_cv1 <- cv.glmnet(nba_x[train, ],
                     nba_y[train],
                     alpha = 1)

NBA_lasso <- glmnet(nba_x[train, ],
                    nba_y[train],
                    alpha = 1,
                    lambda = nba_cv1$lambda.min,
                    thresh = 1e-14)
# test MSE with optimal lambda
NBA_pred1 <- predict(NBA_lasso,
                     s = nba_cv$lambda.min,
                     newx = nba_x[test_x,])

# fitting OLS
NBA_OLS <- glmnet(nba_x[train, ],
                  nba_y[train],
                  alpha = 0,
                  lambda = 0,
                  thresh = 1e-14)

# test MSE with optimal lambda
NBA_pred2 <- predict(NBA_OLS,
                     s = 0,
                     newx = nba_x[test_x,])

# test MSEs, compare with previous models
## use predict() with some of the previous regressions to compare MSEs
mean((NBA_pred - test_y)^2) # ridge
mean((NBA_pred1 - test_y)^2) # lasso
mean((NBA_pred2 - test_y)^2) # OLS
mean((predict(lm(formula = Actual ~ GS. + DRB + PF + yrs_exp + num_accolades + 
                                    NBA_titles + num_teams_1920 + num_teams_played, 
              data = kt_data[train, ]), 
              newx = nba_x[test_x,]) - test_y)^2) # first reduced model (lm2)
mean((predict(lm(formula = Actual ~ yrs_exp + num_teams_played + GS. + 
                                    NBA_titles + num_teams_1920 + PF + DRB, 
              data = kt_data[train, ]), 
              newx = nba_x[test_x,]) - test_y)^2) # reduced model, based off stepwise regression (lm3)
mean((predict(lm(formula = Actual^(31/99) ~ yrs_exp + num_teams_played + GS. + 
                                            NBA_titles + num_teams_1920 + PF + DRB, 
              data = kt_data[train, ]), 
              newx = nba_x[test_x,]) - test_y)^2) # best model after initial y-transformation (lm5)
mean((predict(lm(formula = Actual^(2/9) ~ yrs_exp + num_teams_played + PTS + GS., 
              data = kt_data[train, ]), 
              newx = nba_x[test_x,]) - test_y)^2) # reduced model, y-transformed, with points (lm6)
mean((predict(lm(formula = Actual^(2/9) ~ GS. + FT + yrs_exp + num_teams_played, 
              data = kt_data[train, ]), 
              newx = nba_x[test_x,]) - test_y)^2) # further reduced model, y-transformation (lm7)
mean((predict(lm(formula = Actual^(26/99) ~ yrs_exp * num_teams_played + GS. + NBA_titles + num_teams_1920 + DRB, 
              data = kt_data[test_x,]), 
              newx = nba_x[test_x,]) - test_y)^2) # best model, y-transformation and interaction variable (lm9)
mean((predict(lm(formula = Actual^(26/99) ~ yrs_exp * num_teams_played + GS. + DRB, 
              data = kt_data[test_x,]), 
              newx = nba_x[test_x,]) - test_y)^2) # reduced model w/ interaction variable (lm11)
```

```{r}
## function to return PRESS
PRESS <- function(lm) {
  ## calculate the predictive residuals
  pr <- residuals(lm) / (1 - lm.influence(lm)$hat)
  ## calculate the PRESS
  PRESS <- sum(pr^2)
  return(PRESS)
}
```

```{r}
## analyzing best models
# fifth model
acf(kt_lm5$residuals)
qqnorm(kt_lm5$residuals)
qqline(kt_lm5$residuals, col = 'red')

plot(kt_lm5$fitted.values, kt_lm5$residuals, main = 'Residual Plot, Fifth Model')
abline(h = 0, col= 'red')
vif(kt_lm5)
PRESS(kt_lm5)
```

```{r}
## analyzing best models
# sixth model
acf(kt_lm6$residuals)
qqnorm(kt_lm6$residuals)
qqline(kt_lm6$residuals, col = 'red')

plot(kt_lm6$fitted.values, kt_lm6$residuals, main = 'Residual Plot, Sixth Model')
abline(h = 0, col= 'red')
vif(kt_lm6)
PRESS(kt_lm6)
```

```{r}
# seventh model
acf(kt_lm7$residuals)
qqnorm(kt_lm7$residuals)
qqline(kt_lm7$residuals, col = 'red')

plot(kt_lm7$fitted.values, kt_lm7$residuals, main = 'Residual Plot, Seventh Model')
abline(h = 0, col= 'red')
vif(kt_lm7)
PRESS(kt_lm7)
```

```{r}
# ninth model
acf(kt_lm9$residuals)
qqnorm(kt_lm9$residuals)
qqline(kt_lm9$residuals, col = 'red')

plot(kt_lm9$fitted.values, kt_lm9$residuals, main = 'Residual Plot, Ninth Model')
abline(h = 0, col= 'red')
vif(kt_lm9)
PRESS(kt_lm9)
```

```{r}
# eleventh model
acf(kt_lm11$residuals)
qqnorm(kt_lm11$residuals)
qqline(kt_lm11$residuals, col = 'red')

plot(kt_lm11$fitted.values, kt_lm11$residuals, main = 'Residual Plot, Eleventh Model')
abline(h = 0, col= 'red')
vif(kt_lm11)
PRESS(kt_lm11)
```

## Deciding On A Model

After the use of shrinking methods, and comparing their results to the various regression models previously created, the y-transformed models fare the best, with the lowest MSE values when used on split training and testing data.

While the fifth model, `Actual^(31/99) ~ yrs_exp + num_teams_played + GS. + NBA_titles + num_teams_1920 + PF + DRB` had the lowest MSE during testing, it was only marginally lower than the other y-transformed models. I would settle on the sixth model, using both a y-transformation and more reduced variables. The sixth model had overall the lowest residual standard error, a strong adjusted R-squared value, and the lowest predicted residual error sum of squares (PRESS) statistic.

##note: seventh model has best QQplot, residual plot##

# Fifth Model

```
lm(formula = Actual^(31/99) ~ yrs_exp + num_teams_played + GS. + 
                              NBA_titles + num_teams_1920 + PF + DRB, 
                              data = kt_data)

Coefficients:
                  Estimate Std. Error t value Pr(>|t|)    
(Intercept)      68.772609   3.762377  18.279  < 2e-16 ***
yrs_exp           8.106399   0.548001  14.793  < 2e-16 ***
num_teams_played -8.685130   1.158136  -7.499  3.4e-13 ***
GS.              37.957718   4.763240   7.969  1.3e-14 ***
NBA_titles       -5.984639   2.917020  -2.052 0.040779 *  
num_teams_1920    5.517161   2.466206   2.237 0.025764 *  
PF               -0.005576   0.038728  -0.144 0.885581    
DRB               0.070010   0.018371   3.811 0.000158 ***

Residual standard error: 30.25 on 454 degrees of freedom
Multiple R-squared:  0.6191,	Adjusted R-squared:  0.6133 
F-statistic: 105.4 on 7 and 454 DF,  p-value: < 2.2e-16
PRESS statistic: 436560
```

# Sixth Model (final model)

```
lm(formula = Actual^(2/9) ~ yrs_exp + num_teams_played + 
                            PTS + GS., data = kt_data)

Coefficients:
                   Estimate Std. Error t value Pr(>|t|)    
(Intercept)      21.1058042  0.5080123  41.546  < 2e-16 ***
yrs_exp           1.2779327  0.0887371  14.401  < 2e-16 ***
num_teams_played -1.2568041  0.1896347  -6.627 9.64e-11 ***
PTS               0.0060295  0.0006934   8.695  < 2e-16 ***
GS.               4.6387842  0.8291749   5.594 3.82e-08 ***

Residual standard error: 5.27 on 457 degrees of freedom
Multiple R-squared:  0.6236,	Adjusted R-squared:  0.6203 
F-statistic: 189.3 on 4 and 457 DF,  p-value: < 2.2e-16
PRESS statistic: 13074.99
```

# Seventh Model

```
lm(formula = Actual^(2/9) ~ yrs_exp + num_teams_played + GS. + 
                            NBA_titles + num_teams_1920 + DRB, 
                            data = kt_data)

Coefficients:
                 Estimate Std. Error t value Pr(>|t|)    
(Intercept)      20.45307    0.66662  30.682  < 2e-16 ***
yrs_exp           1.38495    0.09755  14.198  < 2e-16 ***
num_teams_played -1.44323    0.20609  -7.003 9.05e-12 ***
GS.               6.50456    0.82679   7.867 2.66e-14 ***
NBA_titles       -0.99585    0.51940  -1.917   0.0558 .  
num_teams_1920    0.84740    0.42253   2.006   0.0455 *  
DRB               0.01263    0.00231   5.466 7.58e-08 ***

Residual standard error: 5.393 on 455 degrees of freedom
Multiple R-squared:  0.6076,	Adjusted R-squared:  0.6024 
F-statistic: 117.4 on 6 and 455 DF,  p-value: < 2.2e-16
PRESS statistic: 13819.04
```

# Ninth Model

```
lm(formula = Actual^(26/99) ~ yrs_exp * num_teams_played + GS. + 
                              NBA_titles + num_teams_1920 + DRB, 
                              data = kt_data)

Coefficients:
                          Estimate Std. Error t value Pr(>|t|)    
(Intercept)              29.831574   1.609348  18.536  < 2e-16 ***
yrs_exp                   4.317675   0.278006  15.531  < 2e-16 ***
num_teams_played          0.365395   0.700869   0.521   0.6024    
GS.                      12.907147   1.737565   7.428 5.50e-13 ***
NBA_titles               -2.670163   1.083851  -2.464   0.0141 *  
num_teams_1920            0.897823   0.895176   1.003   0.3164    
DRB                       0.024818   0.004823   5.146 3.97e-07 ***
yrs_exp:num_teams_played -0.423850   0.064948  -6.526 1.81e-10 ***

Residual standard error: 11.23 on 454 degrees of freedom
Multiple R-squared:  0.6467,	Adjusted R-squared:  0.6413 
F-statistic: 118.7 on 7 and 454 DF,  p-value: < 2.2e-16
PRESS statistic: 60303.16
```

# Eleventh Model
```
lm(formula = Actual^(26/99) ~ yrs_exp * num_teams_played + GS. + 
    DRB, data = kt_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-49.560  -6.326   0.422   6.918  32.542 

Coefficients:
                          Estimate Std. Error t value Pr(>|t|)    
(Intercept)              30.633871   1.455689  21.044  < 2e-16 ***
yrs_exp                   4.130573   0.269566  15.323  < 2e-16 ***
num_teams_played          0.653170   0.664091   0.984    0.326    
GS.                      12.436927   1.685451   7.379 7.61e-13 ***
DRB                       0.027390   0.004555   6.013 3.74e-09 ***
yrs_exp:num_teams_played -0.426542   0.064106  -6.654 8.21e-11 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 11.3 on 456 degrees of freedom
Multiple R-squared:  0.6411,	Adjusted R-squared:  0.6372 
F-statistic: 162.9 on 5 and 456 DF,  p-value: < 2.2e-16
PRESS statistic: 60513.68
```

```{r}
## finding outliers
## using tenth model, with interaction variable
kt_lm6res <- rstandard(kt_lm6)
kt_lm6studentres <- rstudent(kt_lm6)

# plotting
par(mfrow = c(1, 3))
plot(kt_lm6$fitted.values, kt_lm6$residuals, main = "Residuals")
plot(kt_lm6$fitted.values, kt_lm6res, main = "Studentized Residuals")
plot(kt_lm6$fitted.values, kt_lm6studentres, main = "Externally Studentized Residuals")
kt_lm6studentres[abs(kt_lm6studentres) > qt(1 - 0.05 / (2 * 462), 462 - 4 - 1)]
```

```{r}
## players with high leverage
NBA_leverage <- lm.influence(kt_lm6)$hat
NBA_leverage <- NBA_leverage[NBA_leverage > 2 * 4 / 462]
NBA_leverage

# plotting
plot(NBA_leverage, main = "Leverages", ylim = c(0, 0.2))
abline(h = 2 * 4 / 462, col = "red")
```

```{r}
# DFFITS
NBA_DFFITS <- dffits(kt_lm6)
NBA_DFFITS <- NBA_DFFITS[abs(NBA_DFFITS) > 2 * sqrt(4 / 462)]
NBA_DFFITS
```


```{r}
# Cook's distance
NBA_COOKS <- cooks.distance(kt_lm6)
NBA_COOKS <- NBA_COOKS[NBA_COOKS > qf(0.95, 4, 462 - 4)]
NBA_COOKS
```

```{r}
## indexes for players who are outliers in terms of salary
# measured by both leverage and DFFITS
outlier_index <- c(names(NBA_DFFITS), names(NBA_leverage)) %>% 
                  unique() %>% 
                  as.numeric() %>% 
                  sort()

## apply model to outlier players to find predicted salary
outlier_pred <- predict(kt_lm7, newx = kt_data, type = 'response', level = 0.95)

## as response variable has y-transformation, find the base for actual predicted salary figures
outlier_pred <- exp(log(outlier_pred) / (2/9))

## create data frame with player names, actual salary, predicted salary, and residuals
pred_results <- data.frame(Player = kt_data$Player, 
                           Team = kt_data$team,
                           Actual_Salary = kt_data$Actual, 
                           Predicted_Salary = outlier_pred)

## residual equals the difference between Actual and Predicted salaries
pred_results$Residuals <- pred_results$Actual_Salary - pred_results$Predicted_Salary

## percent (%) value the player is over or underpaid by
pred_results$Salary_DeltaPCT <- ((pred_results$Residuals / pred_results$Actual_Salary) * 100) %>% round(2)

## string for easy output of results
pred_results$String <- ifelse(pred_results$Salary_DeltaPCT < 0, 
                              sprintf('%s was underpaid by $%s (%.1f%%)', 
                                      pred_results$Player, 
                                      abs(pred_results$Residuals) %>% 
                                        round(2) %>% 
                                        format(big.mark = ',', nsmall = 2, trim = TRUE), 
                                      pred_results$Salary_DeltaPCT), 
                              sprintf('%s was overpaid by $%s (%.1f%%)', 
                                      pred_results$Player, 
                                      abs(pred_results$Residuals) %>% 
                                        round(2) %>% 
                                        format(big.mark = ',', nsmall = 2, trim = TRUE), 
                                      pred_results$Salary_DeltaPCT))
```

```{r}
## top ten most overpaid players, by pct
head(arrange(pred_results[outlier_index, ], desc(Salary_DeltaPCT)), n = 10)$String
```


```{r}
## top ten most underpaid players, by pct
head(arrange(pred_results[outlier_index, ], Salary_DeltaPCT), n = 10)$String
```


```{r}
## top ten most overpaid players, by total residual (dollar amount)
head(arrange(pred_results[outlier_index, ], desc(Residuals)), n = 10)$String
```


```{r}
## top ten most underpaid players, by total residual (dollar amount)
head(arrange(pred_results[outlier_index, ], Residuals), n = 10)$String
```

```{r}
## all outliers
pred_results[outlier_index, c('String')]
```

```{r}
# over/underpay, by team
salary_by_team <- pred_results %>% 
                    group_by(Team) %>% 
                    summarise(Salary_ResidualSum = sum(Residuals), 
                              Salary_DeltaPCTMean = (sum(Residuals) / sum(Actual_Salary)) %>%  round(3), 
                              .groups = 'drop') %>% 
                    data.frame()
```

```{r}
## top ten most overpaying teams, by pct
head(arrange(salary_by_team, desc(Salary_DeltaPCTMean)), n = 10)
```


```{r}
## most underpaying teams, by pct
head(arrange(salary_by_team[which(salary_by_team$Salary_DeltaPCTMean < 0),], Salary_DeltaPCTMean), n = 10)
```


```{r}
## top ten most overpaying teams, by total residual (dollar amount)
head(arrange(salary_by_team, desc(Salary_ResidualSum)), n = 10)
```


```{r}
## most underpaying teams, by total residual (dollar amount)
head(arrange(salary_by_team[which(salary_by_team$Salary_ResidualSum < 0),], Salary_ResidualSum), n = 10)
```

## Finding The Most Overpaid And Underpaid Players In The NBA

When applying our predictive model and searching for outliers in the dataset, these were the most overpaid and underpaid NBA athletes of the 2019-2020 season:

# Most Overpaid

Players most overpaid, by percentage of their salary.

1. Chandler Parsons was overpaid by $21,814,406.41 (86.9%)
2. Evan Turner was overpaid by $15,187,441.33 (81.6%)     
3. Allen Crabbe was overpaid by $14,149,730.92 (79.4%)
4. Wayne Ellington was overpaid by $6,022,526.20 (77.2%)  
5. Otto Porter was overpaid by $20,683,328.75 (75.9%)
6. Ish Smith was overpaid by $4,270,245.23 (73.0%)        
7. Justin Holiday was overpaid by $3,416,420.00 (71.7%)
8. Courtney Lee was overpaid by $8,874,016.66 (69.5%)     
9. D'Angelo Russell was overpaid by $18,753,311.43 (68.7%)
10. Kyrie Irving was overpaid by $21,706,041.95 (68.4%)    

**Honorable Mention:** 
Players most overpaid, in total dollars (if not previously mentioned above).

- Blake Griffin was overpaid by $18,735,279.47 (54.7%)
- Devin Booker was overpaid by $16,299,870.78 (59.8%)
- Nicolas Batum was overpaid by $14,347,813.47 (56.1%)   
- Victor Oladipo was overpaid by $14,209,371.37 (67.7%)

# Most Underpaid

Players most underpaid, by percentage of their salary.

1. Jamal Crawford was underpaid by $9,801,173.47 (-3382.0%)
2. Lance Thomas was underpaid by $5,543,698.57 (-2114.7%)    
3. Luguentz Dort was underpaid by $2,615,472.60 (-1680.4%)
4. Carmelo Anthony was underpaid by $34,217,396.84 (-1584.8%)
5. Luc Mbah a Moute was underpaid by $3,683,171.41 (-1270.9%)
6. Corey Brewer was underpaid by $2,398,309.60 (-827.6%)     
7. Udonis Haslem was underpaid by $18,101,902.04 (-705.8%)
8. Vince Carter was underpaid by $16,672,187.90 (-650.0%)    
9. J.J. Barea was underpaid by $11,383,154.97 (-443.8%)
10. Tyler Zeller was underpaid by $919,804.14 (-374.4%)       

**Honorable Mention:** 
Players most underpaid, in total dollars (if not previously mentioned above).

- Andre Drummond was underpaid by $30,760,326.65 (-113.5%)
- LaMarcus Aldridge was underpaid by $10,629,407.34 (-40.9%)
- Tyson Chandler was underpaid by $8,617,217.59 (-336.0%)
- Alec Burks was underpaid by $7,789,537.25 (-335.8%)
- Wesley Matthews was underpaid by $7,765,215.57 (-302.8%)
